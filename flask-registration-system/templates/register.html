{% extends 'layout.html' %}
{% block title %}Register{% endblock %}
{% block content %}
<div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow p-4" style="max-width: 500px; width: 100%;">
        <h2 class="text-center text-primary">Register</h2>

        <form method="POST" action="{{ url_for('register') }}" id="registerForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Email -->
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" placeholder="Enter your email" required>
            </div>

            <!-- Password -->
            <div class="mb-3">
                <label class="form-label">Password</label>
                <div class="input-group">
                    <input type="password" name="password" id="password" class="form-control" placeholder="Enter password" required>
                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>

                <!-- Password Requirements Checklist -->
                <ul id="passwordRequirements" class="list-unstyled mt-2 small text-muted" style="display:none;">
                    <li id="reqLength">❌ At least 8 characters</li>
                    <li id="reqUpper">❌ One uppercase letter</li>
                    <li id="reqLower">❌ One lowercase letter</li>
                    <li id="reqNumber">❌ One number</li>
                    <li id="reqSpecial">❌ One special character</li>
                </ul>

                <!-- Password Strength Bar -->
                <div class="progress mt-2" style="height: 5px;">
                    <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Confirm Password -->
            <div class="mb-3">
                <label class="form-label">Confirm Password</label>
                <input type="password" name="confirm_password" id="confirm_password" class="form-control" placeholder="Re-enter password" required>
            </div>

            <!-- Phone -->
            <div class="mb-3">
                <label class="form-label">Phone</label>
                <input type="text" name="phone" class="form-control" placeholder="Enter your phone" pattern="[0-9]{10}" title="Please enter a 10-digit phone number">
            </div>

            <!-- Gender -->
            <div class="mb-3">
                <label class="form-label">Gender</label>
                <select name="gender" class="form-select">
                    <option value="">Select gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <!-- Google reCAPTCHA -->
            <div class="mt-3">
                <div class="g-recaptcha" data-sitekey="{{ config['RECAPTCHA_SITE_KEY'] }}"></div>

            <!-- Submit -->
            <button type="submit" class="btn btn-success w-100 mt-3">Register</button>
        </form>
    </div>
</div>

<!-- Load Google reCAPTCHA API -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}

{% block scripts %}
<script>
// Eye toggle
document.getElementById('togglePassword').addEventListener('click', function () {
    const pwd = document.getElementById('password');
    const icon = this.querySelector('i');
    if (pwd.type === 'password') {
        pwd.type = 'text';
        icon.classList.replace('bi-eye', 'bi-eye-slash');
    } else {
        pwd.type = 'password';
        icon.classList.replace('bi-eye-slash', 'bi-eye');
    }
});

// Confirm password live match
document.getElementById('confirm_password').addEventListener('input', function () {
    const pwd = document.getElementById('password').value;
    const confirmPwd = this.value;
    if (pwd !== confirmPwd) {
        this.setCustomValidity("Passwords do not match");
    } else {
        this.setCustomValidity("");
    }
});

// Password requirements (hidden until typing)
const passwordField = document.getElementById('password');
const requirements = document.getElementById('passwordRequirements');

passwordField.addEventListener('focus', () => {
    requirements.style.display = 'block';
});

passwordField.addEventListener('blur', () => {
    if (!passwordField.value) {
        requirements.style.display = 'none';
    }
});

passwordField.addEventListener('input', () => {
    const pwd = passwordField.value;

    // Update checklist
    document.getElementById('reqLength').textContent = (pwd.length >= 8 ? "✅" : "❌") + " At least 8 characters";
    document.getElementById('reqUpper').textContent = (/[A-Z]/.test(pwd) ? "✅" : "❌") + " One uppercase letter";
    document.getElementById('reqLower').textContent = (/[a-z]/.test(pwd) ? "✅" : "❌") + " One lowercase letter";
    document.getElementById('reqNumber').textContent = (/[0-9]/.test(pwd) ? "✅" : "❌") + " One number";
    document.getElementById('reqSpecial').textContent = (/[!@#$%^&*(),.?":{}|<>]/.test(pwd) ? "✅" : "❌") + " One special character";

    // Update password strength bar
    let strength = 0;
    if (pwd.length >= 8) strength++;
    if (/[A-Z]/.test(pwd)) strength++;
    if (/[a-z]/.test(pwd)) strength++;
    if (/[0-9]/.test(pwd)) strength++;
    if (/[!@#$%^&*(),.?":{}|<>]/.test(pwd)) strength++;

    const colors = ["bg-danger", "bg-warning", "bg-info", "bg-primary", "bg-success"];
    const widths = ["20%", "40%", "60%", "80%", "100%"];
    const strengthBar = document.getElementById('passwordStrength');

    strengthBar.className = "progress-bar";
    if (strength > 0) {
        strengthBar.style.width = widths[strength - 1];
        strengthBar.classList.add(colors[strength - 1]);
    } else {
        strengthBar.style.width = "0%";
    }
});
</script>
{% endblock %}
